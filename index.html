<!-- csv-to-text2qti-no-images.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CSV ‚Üí text2qti Plain-Text Generator for Canvas</title>
<style>
html, body { margin: 0; padding: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: #111; background: #f7f7fb; }
.header { background: #201D52; color: #fff; padding: 24px; }
.header h1 { margin: 0 0 8px 0; font-size: 22px; font-weight: 700; }
.header p { margin: 0; font-size: 14px; opacity: 0.9; }
.container { max-width: 1040px; margin: 24px auto; padding: 0 16px 48px 16px; }
.card { background: #fff; border-radius: 14px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); padding: 20px; margin-bottom: 18px; overflow: visible; }
.card h2 { margin: 0 0 8px 0; font-size: 18px; }
.card p { margin: 8px 0; font-size: 14px; }
.controls { display: grid; grid-template-columns: 1fr; gap: 12px; }
label { font-size: 14px; font-weight: 600; display: block; margin-bottom: 6px; }
input[type="file"] { padding: 8px; background: #f1f1f7; border-radius: 10px; border: 1px solid #e6e6ef; width: 100%; }
input[type="text"] { padding: 10px 12px; border-radius: 10px; border: 1px solid #e6e6ef; width: 100%; box-sizing: border-box; font-size: 14px; }
textarea { width: 100%; min-height: 360px; border-radius: 12px; border: 1px solid #e4e4ee; padding: 12px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 13px; background: #fafafe; box-sizing: border-box; }
.buttonrow { display: flex; flex-wrap: wrap; gap: 10px; }
button, a.buttonlink { appearance: none; border: none; background: #6465F1; color: #fff; padding: 10px 14px; border-radius: 10px; font-size: 14px; font-weight: 700; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; }
button.secondary, a.secondary { background: #8F37EB; }
button.ghost, a.ghost { background: #201D52; }
button.gray { background: #4e4e5e; }
.small { font-size: 12px; opacity: 0.85; }
.kv { display: grid; grid-template-columns: minmax(240px, 320px) 1fr; gap: 12px 18px; align-items: start; }
.kv div { padding: 6px 0; line-height: 1.35; word-break: break-word; overflow-wrap: anywhere; }
hr { border: none; height: 1px; background: #eee; margin: 16px 0; }
.notice { background: #DCE5E9; color: #201D52; border-radius: 12px; padding: 12px; font-size: 13px; }
.grid2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 14px; }
.panel { background: #f6f7fb; border: 1px solid #e8e9f3; border-radius: 12px; padding: 12px; }
.linkrow { display: flex; flex-wrap: wrap; gap: 10px; }
footer { text-align: center; font-size: 12px; color: #666; padding: 24px; }
.field { margin-bottom: 12px; }
.fieldrow { display: grid; grid-template-columns: 1fr; gap: 12px; }
.fieldrow.two { grid-template-columns: 1fr 1fr; }
@media (max-width: 640px) { .fieldrow.two { grid-template-columns: 1fr; } }
.helpcode { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 12px; background: #fff; border: 1px solid #e4e4ee; padding: 10px; border-radius: 10px; width: 100%; box-sizing: border-box; white-space: pre-wrap; word-break: break-word; overflow: auto; }
.only-bottom { display: flex; justify-content: center; }
.group-info { background: #f0f8ff; border-left: 4px solid #6465F1; padding: 12px; margin: 10px 0; border-radius: 6px; }
.example-box { background: #f8f8f8; border: 1px solid #ddd; padding: 10px; border-radius: 6px; margin: 10px 0; font-family: monospace; font-size: 13px; }
</style>
</head>
<body>
<div class="header">
  <h1>CSV ‚Üí text2qti Plain-Text Generator for Canvas</h1>
  <p>Upload a CSV and get plain text ready to convert to a QTI .zip for Canvas with question grouping and random selection support.</p>
</div>

<div class="container">
  <div class="card">
    <h2>How to use</h2>
    <p>Prepare your CSV using the template below. <strong>Row 2 is reserved for quiz title, description, and quiz settings only. Questions start at row 3.</strong> The TXT we generate includes only content rows, never the CSV header.</p>
    <div class="buttonrow">
      <button id="downloadTemplate">Download Template CSV</button>
    </div><p></p>
    <div class="notice">
      <strong>Structure:</strong> Row 1 = Headers | Row 2 = Quiz Info & Settings | Row 3+ = Questions<br>
      <strong>Quiz Settings:</strong> ShuffleAnswers, ShowCorrectAnswers, OneQuestionAtATime, and CantGoBack are all set with "true" or "false" values in row 2.<br>
      The QuestionNumber column is for your reference only and won't appear in the output.<br>
      After generating the plain text, convert it to QTI format and import into Canvas.<br><br>
      <strong>‚ö†Ô∏è Important Converter Requirements:</strong><br>
      ‚Ä¢ Point values MUST be integers (whole numbers only). The text2qti converter does not support decimal point values even though Canvas itself does.<br>
      ‚Ä¢ Questions in the same group must all have the same point value when using GroupPointsPerQuestion.
    </div>
  </div>

  <div class="card">
    <h2>CSV columns (in order)</h2>
    <div class="kv">
      <div>QuizTitle (A)</div><div>Title of the quiz (use on row 2 only)</div>
      <div>QuizDescription (B)</div><div>Description of the quiz (use on row 2 only)</div>
      <div>ShuffleAnswers (C)</div><div>true or false - randomize answer order (row 2 only)</div>
      <div>ShowCorrectAnswers (D)</div><div>true or false - show correct answers after submission (row 2 only)</div>
      <div>OneQuestionAtATime (E)</div><div>true or false - only show one question at a time (row 2 only)</div>
      <div>CantGoBack (F)</div><div>true or false - don't allow going back when one-at-a-time (row 2 only)</div>
      <div>QuestionNumber (G)</div><div>For your reference only - not included in output (pre-numbered)</div>
      <div>Group (H)</div><div>Group name for organizing questions. Leave blank for no grouping.</div>
      <div>GroupPick (I)</div><div>Number of questions to randomly select from this group (first row of group only)</div>
      <div>GroupPointsPerQuestion (J)</div><div>Points per question when randomly selected (first row of group only)</div>
      <div>Type (K)</div><div>MC, MR, TF, NUM, SA, ESSAY, FILE, TEXT</div>
      <div>Title (L)</div><div>Optional question or TEXT title</div>
      <div>Points (M)</div><div>Positive integer (whole numbers only - no decimals); ignored for TEXT and when GroupPointsPerQuestion is used</div>
      <div>Body (N)</div><div>Question prompt or TEXT content</div>
      <div>Answer1..Answer5 (O-S)</div><div>MC/MR/TF choice texts; SA acceptable answers; NUM rule in Answer1</div>
      <div>Correct (T)</div><div>MC/TF single number 1‚Äì5; MR comma list like 1,3</div>
      <div>GeneralFeedback (U)</div><div>Shown for all answers when supported</div>
      <div>CorrectFeedback (V)</div><div>Shown on correct</div>
      <div>IncorrectFeedback (W)</div><div>Shown on incorrect</div>
      <div>Choice1Feedback..Choice5Feedback (X-AB)</div><div>Optional per-choice feedback</div>
      <div>TextTitle (AC)</div><div>For Type=TEXT</div>
      <div>TextContent (AD)</div><div>For Type=TEXT</div>
    </div>
  </div>

  <div class="card">
    <h2>Quiz Settings (text2qti supported)</h2>
    <p>These quiz-level settings can be configured in row 2 of your CSV (columns C-F). All are optional and use "true" or "false" values.</p>
    <div class="grid2">
      <div class="panel"><b>Shuffle Answers</b><p>Randomizes the order of answer choices for each question. Useful for preventing cheating when students compare answers.</p></div>
      <div class="panel"><b>Show Correct Answers</b><p>Displays correct answers to students after quiz submission. Consider your pedagogical goals when setting this.</p></div>
      <div class="panel"><b>One Question At A Time</b><p>Shows only one question per page instead of all questions at once. Can help students focus.</p></div>
      <div class="panel"><b>Can't Go Back</b><p>When using one-question-at-a-time, prevents students from returning to previous questions. Use with caution.</p></div>
    </div><p></p>
    <div class="notice">
      <strong>Note:</strong> Other Canvas settings like time limits, access codes, and multiple attempts must be configured directly in Canvas after importing the QTI file. text2qti doesn't support these settings.
    </div>
  </div>

  <div class="card">
    <h2>Question Grouping and Random Selection</h2>
    <div class="group-info">
      <strong>üìö What is Grouping?</strong><br>
      Grouping organizes related questions together (like "Chapter 1" or "Easy Questions"). This helps structure your quiz and enables random question selection.
    </div>
    
    <div class="group-info">
      <strong>‚úÖ How to Use Groups:</strong><br>
      <ul style="margin: 5px 0; padding-left: 20px;">
        <li><b>To group questions:</b> Enter the same group name in column H for all questions you want together</li>
        <li><b>To leave ungrouped:</b> Simply leave column H blank - the question stands alone</li>
        <li><b>Group names:</b> Use any name like "Chapter 1", "Atoms", "Lab Safety", etc.</li>
      </ul>
    </div>
    
    <div class="group-info">
      <strong>üé≤ Random Selection (Optional):</strong><br>
      Want Canvas to randomly pick only some questions from a group? Use columns I and J on the <b>first row of each new group</b>:
      <ul style="margin: 5px 0; padding-left: 20px;">
        <li><b>Column I (GroupPick):</b> How many questions to randomly select</li>
        <li><b>Column J (GroupPointsPerQuestion):</b> Points each selected question is worth</li>
        <li><b>Important:</b> Only fill these in on the first question of a new group, leave blank for other rows</li>
      </ul>
    </div>
    
    <div class="example-box">
      <strong>üìã Examples:</strong><br><br>
      <b>Scenario 1: Random subset with uniform points</b><br>
      ‚Ä¢ Group="Chapter 1", GroupPick=2, GroupPointsPerQuestion=5<br>
      ‚Ä¢ You have 5 questions in Chapter 1<br>
      ‚Üí <em>Canvas randomly picks 2 of the 5 questions, each worth 5 points (10 points total)</em><br><br>
      
      <b>Scenario 2: All questions with individual points</b><br>
      ‚Ä¢ Group="Chapter 2" (leave GroupPick and GroupPointsPerQuestion blank)<br>
      ‚Ä¢ Questions have Points=2, 3, 5, etc.<br>
      ‚Üí <em>All Chapter 2 questions appear, each worth their individual point values</em><br><br>
      
      <b>Scenario 3: No grouping</b><br>
      ‚Ä¢ Leave Group column blank<br>
      ‚Üí <em>Question appears by itself, not part of any group</em>
    </div>
    
    <div class="example-box" style="overflow-x: auto;">
      <strong>üìä Visual CSV Example (showing questions from row 3 onwards) - Notice GroupPick & GroupPointsPerQuestion only on FIRST row of each group:</strong><br><br>
      <table style="border-collapse: collapse; font-size: 12px; width: 100%; min-width: 600px;">
        <thead>
          <tr style="background: #f0f0f0;">
            <th style="border: 1px solid #ddd; padding: 4px;">QuestionNumber</th>
            <th style="border: 1px solid #ddd; padding: 4px;">Group</th>
            <th style="border: 1px solid #ddd; padding: 4px;">GroupPick</th>
            <th style="border: 1px solid #ddd; padding: 4px;">GroupPointsPerQuestion</th>
            <th style="border: 1px solid #ddd; padding: 4px;">Type</th>
            <th style="border: 1px solid #ddd; padding: 4px;">Body</th>
            <th style="border: 1px solid #ddd; padding: 4px;">...</th>
          </tr>
        </thead>
        <tbody>
          <tr style="background: #e8f4fd;">
            <td style="border: 1px solid #ddd; padding: 4px;">1</td>
            <td style="border: 1px solid #ddd; padding: 4px;"><b>Chapter 1</b></td>
            <td style="border: 1px solid #ddd; padding: 4px; background: #ffffcc;"><b>2</b></td>
            <td style="border: 1px solid #ddd; padding: 4px; background: #ffffcc;"><b>3</b></td>
            <td style="border: 1px solid #ddd; padding: 4px;">MC</td>
            <td style="border: 1px solid #ddd; padding: 4px;">What is H‚ÇÇO?</td>
            <td style="border: 1px solid #ddd; padding: 4px;">...</td>
          </tr>
          <tr>
            <td style="border: 1px solid #ddd; padding: 4px;">2</td>
            <td style="border: 1px solid #ddd; padding: 4px;">Chapter 1</td>
            <td style="border: 1px solid #ddd; padding: 4px; background: #f9f9f9;"></td>
            <td style="border: 1px solid #ddd; padding: 4px; background: #f9f9f9;"></td>
            <td style="border: 1px solid #ddd; padding: 4px;">TF</td>
            <td style="border: 1px solid #ddd; padding: 4px;">Water boils at 100¬∞C</td>
            <td style="border: 1px solid #ddd; padding: 4px;">...</td>
          </tr>
          <tr>
            <td style="border: 1px solid #ddd; padding: 4px;">3</td>
            <td style="border: 1px solid #ddd; padding: 4px;">Chapter 1</td>
            <td style="border: 1px solid #ddd; padding: 4px; background: #f9f9f9;"></td>
            <td style="border: 1px solid #ddd; padding: 4px; background: #f9f9f9;"></td>
            <td style="border: 1px solid #ddd; padding: 4px;">MC</td>
            <td style="border: 1px solid #ddd; padding: 4px;">pH of pure water?</td>
            <td style="border: 1px solid #ddd; padding: 4px;">...</td>
          </tr>
          <tr style="background: #ffe8e8;">
            <td style="border: 1px solid #ddd; padding: 4px;">4</td>
            <td style="border: 1px solid #ddd; padding: 4px;"><b>Chapter 2</b></td>
            <td style="border: 1px solid #ddd; padding: 4px; background: #f9f9f9;"></td>
            <td style="border: 1px solid #ddd; padding: 4px; background: #f9f9f9;"></td>
            <td style="border: 1px solid #ddd; padding: 4px;">MC</td>
            <td style="border: 1px solid #ddd; padding: 4px;">What is an atom?</td>
            <td style="border: 1px solid #ddd; padding: 4px;">...</td>
          </tr>
          <tr>
            <td style="border: 1px solid #ddd; padding: 4px;">5</td>
            <td style="border: 1px solid #ddd; padding: 4px;">Chapter 2</td>
            <td style="border: 1px solid #ddd; padding: 4px; background: #f9f9f9;"></td>
            <td style="border: 1px solid #ddd; padding: 4px; background: #f9f9f9;"></td>
            <td style="border: 1px solid #ddd; padding: 4px;">NUM</td>
            <td style="border: 1px solid #ddd; padding: 4px;">Atomic number of Carbon?</td>
            <td style="border: 1px solid #ddd; padding: 4px;">...</td>
          </tr>
          <tr style="background: #f0f0f0;">
            <td style="border: 1px solid #ddd; padding: 4px;">6</td>
            <td style="border: 1px solid #ddd; padding: 4px; background: #f9f9f9;"></td>
            <td style="border: 1px solid #ddd; padding: 4px; background: #f9f9f9;"></td>
            <td style="border: 1px solid #ddd; padding: 4px; background: #f9f9f9;"></td>
            <td style="border: 1px solid #ddd; padding: 4px;">TF</td>
            <td style="border: 1px solid #ddd; padding: 4px;">All acids are dangerous</td>
            <td style="border: 1px solid #ddd; padding: 4px;">...</td>
          </tr>
        </tbody>
      </table>
      <br>
      <div style="font-size: 12px;">
        <b>Note:</b> Row 2 (not shown) contains only QuizTitle, QuizDescription, and quiz settings. Questions start at Row 3.<br>
        <span style="background: #e8f4fd; padding: 2px 6px;">Blue rows</span> = First row of Chapter 1 (picks 2 random questions, 3 pts each)<br>
        <span style="background: #ffe8e8; padding: 2px 6px;">Pink row</span> = First row of Chapter 2 (all questions included, individual points)<br>
        <span style="background: #f0f0f0; padding: 2px 6px;">Gray row</span> = No group (standalone question)<br>
        <span style="background: #ffffcc; padding: 2px 6px;">Yellow cells</span> = GroupPick/GroupPointsPerQuestion ONLY on first row of group!
      </div>
    </div>
    
    <div class="notice">
      <strong>üí° Tips:</strong> 
      ‚Ä¢ GroupPick is great for creating question pools where students get different questions<br>
      ‚Ä¢ When using GroupPointsPerQuestion, individual Points values are ignored for that group<br>
      ‚Ä¢ You can mix grouped and ungrouped questions in the same quiz
    </div>
  </div>

  <div class="card">
    <h2>Question type instructions</h2>
    <div class="grid2">
      <div class="panel"><b>MC</b><p>Single correct choice. Put choices in Answer1..Answer5. Put the correct index in Correct, for example 3.</p></div>
      <div class="panel"><b>MR</b><p>Multiple correct choices. Put choices in Answer1..Answer5. Put a comma list in Correct, for example 1,3.</p></div>
      <div class="panel"><b>TF</b><p>Use Answer1=True and Answer2=False or your own labels. Put Correct=1 for True or 2 for False.</p></div>
      <div class="panel"><b>NUM</b><p>Put the rule in Answer1. Examples: 5 for exact; [1.2598, 1.2600] for range; 1.4142 +- 0.0001 or 100 +- 5% for margin.</p></div>
      <div class="panel"><b>SA</b><p>Put acceptable exact answers in Answer1..Answer5. Case sensitivity follows Canvas/text2qti behavior.</p></div>
      <div class="panel"><b>ESSAY</b><p>No answers needed. The generator adds the essay marker automatically.</p></div>
      <div class="panel"><b>FILE</b><p>No answers needed. The generator adds the file-upload marker automatically.</p></div>
      <div class="panel"><b>TEXT</b><p>Non-question content. Use TextTitle and TextContent. No points.</p></div>
    </div>
  </div>

  <div class="card">
    <h2>CSV ‚Üí TXT</h2>
    <div class="controls">
      <label for="csvFile">Choose CSV file</label>
      <input type="file" id="csvFile" accept=".csv,text/csv">
      <div class="buttonrow">
        <button id="convertBtn">Convert CSV ‚Üí Plain Text</button>
        <button id="clearBtn" class="gray">Clear</button>
      </div>
    </div>
    <textarea id="output" placeholder="Your text2qti-compatible plain text will appear here. The header row is never included."></textarea>
    <div class="buttonrow" style="margin-top:10px;">
      <button id="copyBtn">Copy To Clipboard</button>
      <button id="downloadTxtBtn" class="secondary">Download .txt</button>
    </div>
  </div>

  <div class="card only-bottom">
    <button id="goToConverterBottom" class="secondary">Continue to text2qti Converter</button>
  </div>
</div>

<footer>CSV ‚Üí text2qti Generator ‚Ä¢ Works offline in your browser</footer>

<script>
function parseCSV(text) {
  var rows = [];
  var i = 0;
  var field = "";
  var row = [];
  var inQuotes = false;
  while (i < text.length) {
    var c = text[i];
    if (inQuotes) {
      if (c === '"') {
        if (i + 1 < text.length && text[i + 1] === '"') {
          field += '"';
          i += 2;
        } else {
          inQuotes = false;
          i += 1;
        }
      } else {
        field += c;
        i += 1;
      }
    } else {
      if (c === '"') {
        inQuotes = true;
        i += 1;
      } else if (c === ",") {
        row.push(field);
        field = "";
        i += 1;
      } else if (c === "\r") {
        i += 1;
      } else if (c === "\n") {
        row.push(field);
        rows.push(row);
        row = [];
        field = "";
        i += 1;
      } else {
        field += c;
        i += 1;
      }
    }
  }
  row.push(field);
  rows.push(row);
  return rows;
}

function safe(v) { if (v === undefined || v === null) return ""; return String(v).trim(); }
function has(val) { return val && String(val).trim().length > 0; }

function headerIndexMap(header) {
  var idx = {};
  for (var i = 0; i < header.length; i++) idx[header[i].toLowerCase()] = i;
  return function(name) {
    var key = name.toLowerCase();
    return idx.hasOwnProperty(key) ? idx[key] : -1;
  };
}

function buildTextFromRows(rows) {
  if (!rows || rows.length === 0) return "";
  var header = rows[0].map(safe);
  var col = headerIndexMap(header);
  var out = [];
  var currentGroup = "";
  var inGroup = false;
  
  // Handle quiz title, description, and settings from row 2
  if (rows.length > 1) {
    var titleRow = rows[1];
    var qtitle = safe(titleRow[col("QuizTitle")]);
    var qdesc = safe(titleRow[col("QuizDescription")]);
    var shuffleAnswers = safe(titleRow[col("ShuffleAnswers")]);
    var showCorrectAnswers = safe(titleRow[col("ShowCorrectAnswers")]);
    var oneQuestionAtATime = safe(titleRow[col("OneQuestionAtATime")]);
    var cantGoBack = safe(titleRow[col("CantGoBack")]);
    
    if (has(qtitle)) out.push("Quiz title: " + qtitle);
    if (has(qdesc)) out.push("Quiz description: " + qdesc);
    
    // Add quiz settings if specified
    if (has(shuffleAnswers)) out.push("shuffle answers: " + shuffleAnswers.toLowerCase());
    if (has(showCorrectAnswers)) out.push("show correct answers: " + showCorrectAnswers.toLowerCase());
    if (has(oneQuestionAtATime)) out.push("one question at a time: " + oneQuestionAtATime.toLowerCase());
    if (has(cantGoBack)) out.push("can't go back: " + cantGoBack.toLowerCase());
  }
  
  // Process questions starting from row 3
  for (var r = 2; r < rows.length; r++) {
    var row = rows[r];
    if (!row || row.length === 0) continue;
    
    var group = safe(row[col("Group")]);
    var groupPick = safe(row[col("GroupPick")]);
    var groupPoints = safe(row[col("GroupPointsPerQuestion")]);
    var type = safe(row[col("Type")]).toUpperCase();
    
    if (!has(type)) continue;
    
    // Handle group changes
    if (has(group) && group !== currentGroup) {
      // Close previous group if one was open
      if (inGroup) {
        out.push("END_GROUP");
      }
      
      // Start new group
      out.push("GROUP");
      if (has(groupPick)) {
        out.push("pick: " + groupPick);
      }
      if (has(groupPoints)) {
        out.push("points per question: " + groupPoints);
      }
      currentGroup = group;
      inGroup = true;
    } else if (!has(group) && inGroup) {
      // End group when moving to ungrouped question
      out.push("END_GROUP");
      currentGroup = "";
      inGroup = false;
    }
    
    if (type === "TEXT") {
      var tTitle = safe(row[col("TextTitle")]);
      var tBody = safe(row[col("TextContent")]);
      if (has(tTitle)) out.push("Text title:  " + tTitle);
      if (has(tBody)) out.push("Text:  " + tBody);
      continue;
    }
    
    var title = safe(row[col("Title")]);
    var points = safe(row[col("Points")]);
    var body = safe(row[col("Body")]);
    var a1 = safe(row[col("Answer1")]);
    var a2 = safe(row[col("Answer2")]);
    var a3 = safe(row[col("Answer3")]);
    var a4 = safe(row[col("Answer4")]);
    var a5 = safe(row[col("Answer5")]);
    var cAns = safe(row[col("Correct")]);
    var gfb = safe(row[col("GeneralFeedback")]);
    var cfb = safe(row[col("CorrectFeedback")]);
    var ifb = safe(row[col("IncorrectFeedback")]);
    var ch1fb = safe(row[col("Choice1Feedback")]);
    var ch2fb = safe(row[col("Choice2Feedback")]);
    var ch3fb = safe(row[col("Choice3Feedback")]);
    var ch4fb = safe(row[col("Choice4Feedback")]);
    var ch5fb = safe(row[col("Choice5Feedback")]);
    
    if (has(title)) out.push("Title: " + title);
    if (has(points)) out.push("Points: " + points);
    if (has(body)) out.push("1.  " + body);
    
    if (has(gfb)) out.push("... " + gfb);
    if (has(cfb)) out.push("+   " + cfb);
    if (has(ifb)) out.push("-   " + ifb);
    
    if (type === "MC") {
      var choices = [a1, a2, a3, a4, a5];
      var correctIndex = parseInt(cAns, 10);
      var chFB = [ch1fb, ch2fb, ch3fb, ch4fb, ch5fb];
      for (var i = 0; i < choices.length; i++) {
        if (!has(choices[i])) continue;
        var letter = String.fromCharCode(97 + i);
        var mark = (i + 1 === correctIndex) ? "*" : "";
        var line = mark + letter + ")  " + choices[i];
        out.push(line);
        if (has(chFB[i])) out.push("... " + chFB[i]);
      }
      continue;
    }
    
    if (type === "TF") {
      var tfChoices = [has(a1) ? a1 : "True", has(a2) ? a2 : "False"];
      var tfCorrectIndex = parseInt(cAns, 10);
      var tfFB = [ch1fb, ch2fb];
      for (var j = 0; j < 2; j++) {
        var ltr = String.fromCharCode(97 + j);
        var marktf = (j + 1 === tfCorrectIndex) ? "*" : "";
        out.push(marktf + ltr + ")  " + tfChoices[j]);
        if (has(tfFB[j])) out.push("... " + tfFB[j]);
      }
      continue;
    }
    
    if (type === "MR") {
      var mrChoices = [a1, a2, a3, a4, a5];
      var mrfb = [ch1fb, ch2fb, ch3fb, ch4fb, ch5fb];
      var correctSet = {};
      if (has(cAns)) {
        var parts = cAns.split(",");
        for (var k = 0; k < parts.length; k++) {
          var num = parseInt(parts[k].trim(), 10);
          if (!isNaN(num)) correctSet[num - 1] = true;
        }
      }
      for (var m = 0; m < mrChoices.length; m++) {
        if (!has(mrChoices[m])) continue;
        var markmr = correctSet[m] ? "[*]" : "[ ]";
        out.push(markmr + " " + mrChoices[m]);
        if (has(mrfb[m])) out.push("... " + mrfb[m]);
      }
      continue;
    }
    
    if (type === "NUM") {
      if (has(a1)) out.push("=   " + a1);
      continue;
    }
    
    if (type === "SA") {
      var sa = [a1, a2, a3, a4, a5];
      for (var s = 0; s < sa.length; s++) {
        if (has(sa[s])) out.push("*   " + sa[s]);
      }
      continue;
    }
    
    if (type === "ESSAY") {
      out.push("____");
      continue;
    }
    
    if (type === "FILE") {
      out.push("^^^^");
      continue;
    }
  }
  
  // Close final group if one is still open
  if (inGroup) {
    out.push("END_GROUP");
  }
  
  return out.join("\n");
}

function downloadBlob(filename, text, mime) {
  var blob = new Blob([text], {type: mime || "text/plain;charset=utf-8"});
  var url = URL.createObjectURL(blob);
  var a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  URL.revokeObjectURL(url);
  a.remove();
}

function generateTemplateCSV() {
  var headers = [
    "QuizTitle","QuizDescription","ShuffleAnswers","ShowCorrectAnswers","OneQuestionAtATime","CantGoBack",
    "QuestionNumber","Group","GroupPick","GroupPointsPerQuestion",
    "Type","Title","Points","Body",
    "Answer1","Answer2","Answer3","Answer4","Answer5",
    "Correct","GeneralFeedback","CorrectFeedback","IncorrectFeedback",
    "Choice1Feedback","Choice2Feedback","Choice3Feedback","Choice4Feedback","Choice5Feedback",
    "TextTitle","TextContent"
  ];
  var rows = [];
  
  // Row 2 - Quiz title, description, and settings only
  rows.push([
    "My Chemistry Quiz","This quiz covers chapters 1-3 with random selection and grouping.","true","false","false","false",
    "","","","",
    "","","","",
    "","","","","",
    "","","","",
    "","","","","",
    "",""
  ]);
  
  // Row 3 - First question (TEXT instructions, Chapter 1 group with random selection)
  rows.push([
    "","","","","","",
    "1","Chapter 1","2","3",
    "TEXT","Read First","","",
    "","","","","",
    "","","","",
    "","","","","",
    "Instructions","Answer all questions carefully."
  ]);
  
  // Chapter 1 questions (will pick 2 of these 3 randomly, each worth 3 points)
  rows.push([
    "","","","","","",
    "2","Chapter 1","","",
    "MC","Basic Addition","","What is 2 + 3?",
    "6","1","5","10","",
    "3","General feedback for this question.","Great job!","Check your addition.",
    "6 is too high.","1 is too low.","Correct!","10 is not correct.","",
    "",""
  ]);
  
  rows.push([
    "","","","","","",
    "3","Chapter 1","","",
    "TF","State of Water","","Water is liquid at room temperature.",
    "True","False","","","",
    "1","","","",
    "Correct.","Incorrect.","","","",
    "",""
  ]);
  
  rows.push([
    "","","","","","",
    "4","Chapter 1","","",
    "MC","Subtraction","","What is 10 - 7?",
    "2","3","4","5","",
    "2","","Good work!","Try again.",
    "","Correct!","","","",
    "",""
  ]);
  
  // Chapter 2 group - all questions included with individual points
  rows.push([
    "","","","","","",
    "5","Chapter 2","","",
    "MR","Noble Gases","3","Which of the following are noble gases?",
    "Oxygen","Helium","Neon","Nitrogen","Argon",
    "2,3,5","Multiple correct answers.","Nice selection!","Review the periodic table.",
    "Oxygen is not a noble gas.","Helium is a noble gas.","Neon is a noble gas.","Nitrogen is not a noble gas.","Argon is a noble gas.",
    "",""
  ]);
  
  rows.push([
    "","","","","","",
    "6","Chapter 2","","",
    "NUM","Avogadro's Number","3","What is Avogadro's number (√ó10¬≤¬≥)?",
    "6.022 +- 0.001","","","","",
    "","Any value within the margin is accepted.","","",
    "","","","","",
    "",""
  ]);
  
  // Lab Questions group - pick 1 random question worth 5 points
  rows.push([
    "","","","","","",
    "7","Lab Questions","1","5",
    "SA","Lab Safety Equipment","","What protective equipment covers your eyes in the lab?",
    "goggles","safety goggles","safety glasses","protective goggles","eye protection",
    "","Any of the listed answers earn full credit.","","",
    "","","","","",
    "",""
  ]);
  
  rows.push([
    "","","","","","",
    "8","Lab Questions","","",
    "ESSAY","Lab Safety Essay","","Write an essay about lab safety best practices.",
    "","","","","",
    "","","","",
    "","","","","",
    "",""
  ]);
  
  rows.push([
    "","","","","","",
    "9","Lab Questions","","",
    "FILE","Upload Lab Report","","Upload your completed lab report as a PDF.",
    "","","","","",
    "","","","",
    "","","","","",
    "",""
  ]);
  
  // Questions without a group (standalone)
  rows.push([
    "","","","","","",
    "10","Lab Questions","","",
    "TF","Chemical Safety","1","All chemicals should be treated as potentially hazardous.",
    "True","False","","","",
    "1","Safety first!","Correct!","Always treat chemicals with respect.",
    "","","","","",
    "",""
  ]);
  
  var data = [headers].concat(rows).map(function(arr){ return arr.map(function(x){
    var s = String(x === undefined ? "" : x);
    if (s.indexOf('"') !== -1 || s.indexOf(",") !== -1 || s.indexOf("\n") !== -1) {
      s = '"' + s.replace(/"/g,'""') + '"';
    }
    return s;
  }).join(","); }).join("\n");
  return data;
}

var fileInput = document.getElementById("csvFile");
var convertBtn = document.getElementById("convertBtn");
var clearBtn = document.getElementById("clearBtn");
var output = document.getElementById("output");
var copyBtn = document.getElementById("copyBtn");
var downloadTxtBtn = document.getElementById("downloadTxtBtn");
var downloadTemplate = document.getElementById("downloadTemplate");

convertBtn.addEventListener("click", function(){
  if (!fileInput.files || fileInput.files.length === 0) {
    alert("Please choose a CSV file first.");
    return;
  }
  var file = fileInput.files[0];
  var reader = new FileReader();
  reader.onload = function(e){
    var text = e.target.result || "";
    var rows = parseCSV(text);
    var out = buildTextFromRows(rows);
    output.value = out;
    if (out.trim().length === 0) {
      alert("No output produced. Check your headers and rows.");
    }
  };
  reader.readAsText(file);
});

clearBtn.addEventListener("click", function(){
  fileInput.value = "";
  output.value = "";
});

copyBtn.addEventListener("click", function(){
  output.select();
  document.execCommand("copy");
  alert("Copied to clipboard.");
});

downloadTxtBtn.addEventListener("click", function(){
  var text = output.value || "";
  if (text.trim().length === 0) {
    alert("No text to download.");
    return;
  }
  downloadBlob("quiz.txt", text, "text/plain;charset=utf-8");
});

downloadTemplate.addEventListener("click", function(){
  var csv = generateTemplateCSV();
  downloadBlob("canvas_quiz_template_with_groups_numbered.csv", csv, "text/csv;charset=utf-8");
});

document.getElementById("goToConverterBottom").addEventListener("click", function(){
  window.open("http://ec2-34-207-154-191.compute-1.amazonaws.com", "_blank");
});
</script>
</body>
</html>
